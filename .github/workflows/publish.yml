# .github/workflows/publish.yml
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# GitHub â†’ Blogger GitOps
#   â€¢ å¤‰æ›´ï¼è¿½åŠ   : posts.patch   â†’ æ—¢å­˜è¨˜äº‹ã‚’æ›´æ–°
#   â€¢ æ–°è¦        : posts.insert  â†’ æ–°è¦å…¬é–‹ or ä¸‹æ›¸ã
#   â€¢ å‰Šé™¤ (git rm): posts.remove â†’ æ’ä¹…å‰Šé™¤ï¼ˆã‚´ãƒŸç®±ã‚’ä»‹ã•ãªã„ï¼‰
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
name: Publish Blogger

on:
  push:
    branches: [ main ]
    paths:    [ 'posts/**/*.md' ]
  workflow_dispatch:
    inputs:
      path:
        description: "å˜ä¸€ Markdown (posts/xxx.md)"
        required: false
      publish:
        description: "true=å…¬é–‹ / false=ä¸‹æ›¸ã (insert/patch æ™‚)"
        default: "true"
        type: choice
        options: ["true","false"]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
    #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 1) Checkoutï¼ˆå…¨å±¥æ­´ï¼‰ & Go
    #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - uses: actions/checkout@v4
      with: { fetch-depth: 0 }

    - uses: actions/setup-go@v5
      with: { go-version: '1.22' }

    - run: go mod tidy

    #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 2) å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ« (è¿½åŠ /æ›´æ–°) æŠ½å‡º
    #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Select files (push)
      id: sel
      if: github.event_name == 'push'
      run: |
        before="${{ github.event.before }}"
        after="${{ github.sha }}"
        [ -z "$before" ] && before=$(git rev-parse "$after^")

        files=$(git diff -z --diff-filter=AM --name-only "$before" "$after" -- posts \
                | tr '\0' '\n' | paste -sd ',' -)

        echo "files=$files" >> "$GITHUB_OUTPUT"

    #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 3) æ‰‹å‹•å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«
    #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Select files (manual)
      id: sel_manual
      if: github.event_name == 'workflow_dispatch'
      run: |
        echo "files=${{ github.event.inputs.path }}" >> "$GITHUB_OUTPUT"

    #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 4) å‰Šé™¤ãƒ•ã‚¡ã‚¤ãƒ«æŠ½å‡º
    #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Detect deleted files
      id: del
      if: github.event_name == 'push'
      run: |
        before="${{ github.event.before }}"
        after="${{ github.sha }}"
        [ -z "$before" ] && before=$(git rev-parse "$after^")

        deleted=$(git diff --name-status "$before" "$after" -- posts \
                 | awk '$1=="D"{print $2}' | paste -sd ',' -)
        echo "deleted=$deleted" >> "$GITHUB_OUTPUT"

    #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 5) Publish è¿½åŠ  / æ›´æ–°
    #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Publish each file
      if: ${{ steps.sel.outputs.files || steps.sel_manual.outputs.files }}
      env:
        FILES:  ${{ steps.sel.outputs.files || steps.sel_manual.outputs.files }}
        BLOGGER_CLIENT_ID:      ${{ secrets.BLOGGER_CLIENT_ID }}
        BLOGGER_CLIENT_SECRET:  ${{ secrets.BLOGGER_CLIENT_SECRET }}
        BLOGGER_REFRESH_TOKEN:  ${{ secrets.BLOGGER_REFRESH_TOKEN }}
        BLOG_ID:                ${{ secrets.BLOG_ID }}
        RAW_BASE: "https://raw.githubusercontent.com/${{ github.repository }}/main"
      run: |
        IFS=',' read -ra ARR <<< "$FILES"
        for f in "${ARR[@]}"; do
          [ -z "$f" ] && continue
          echo "publishing $f"
          go run ./cmd/publish -path "$f" -publish "${{ github.event.inputs.publish || 'true' }}"
        done

    #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 6) Permanently delete removed files
    #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Delete each file
      if: ${{ steps.del.outputs.deleted }}
      env:
        DELETED: ${{ steps.del.outputs.deleted }}
        BLOGGER_CLIENT_ID:      ${{ secrets.BLOGGER_CLIENT_ID }}
        BLOGGER_CLIENT_SECRET:  ${{ secrets.BLOGGER_CLIENT_SECRET }}
        BLOGGER_REFRESH_TOKEN:  ${{ secrets.BLOGGER_REFRESH_TOKEN }}
        BLOG_ID:                ${{ secrets.BLOG_ID }}
      run: |
        before="${{ github.event.before }}"
        [ -z "$before" ] && before=$(git rev-parse "${{ github.sha }}^")

        IFS=',' read -ra ARR <<< "$DELETED"
        for f in "${ARR[@]}"; do
          [ -z "$f" ] && continue
          id=$(git show "$before:$f" 2>/dev/null \
                | sed -n -E '1,/^---/p' \
                | grep -m1 -E '^[[:space:]]*blogger_id' \
                | sed -E 's/^[[:space:]]*blogger_id[[:space:]]*:[[:space:]]*"?([^"]+)"?/\1/')

          # ---- ID ãŒå–ã‚Œãªã‘ã‚Œã°å³ã‚¨ãƒ©ãƒ¼ã§è½ã¨ã™ ----
          if [ -z "$id" ]; then
            echo "âŒ blogger_id not found in $f"
            exit 1
          fi

          echo "ðŸ—‘  delete $f -> $id"
          go run ./cmd/delete -id "$id"
        done
